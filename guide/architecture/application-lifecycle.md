
# 应用生命周期

## 概览

Goal-Web 的应用生命周期围绕 "应用实例 + 服务提供者 + 请求处理" 三个核心阶段展开：

- 应用启动：创建应用实例，注册所有服务提供者
- 服务启动：并发启动各个基础服务（数据库、队列、HTTP 等）
- 请求处理：接收请求，通过路由和中间件分发到控制器
- 应用停止：优雅关闭服务，释放资源

理解生命周期，有助于你在正确的时机注册服务、执行启动逻辑，以及安排资源释放。

## 应用对象

应用对象实现了 `contracts.Application` 接口，它本质上是一个带有服务容器能力的核心对象：

- 嵌入 `Container`：提供依赖注入和对象解析能力
- 管理服务提供者：负责注册和启动各个组件
- 管理调试开关：决定是否输出调试日志

接口定义可以在 `contracts/application.go` 中找到。

## 启动流程

典型的启动流程可以分为三个步骤：

1. 创建应用实例
2. 注册服务提供者
3. 启动服务并开始处理请求

在你的 `main.go` 中，一般会先创建应用并注册需要的服务提供者（HTTP、数据库、队列等），然后调用 `Start`：

```go
app := application.NewApplication()

app.RegisterServices(
    &http.ServiceProvider{},
    &database.ServiceProvider{},
    &queue.ServiceProvider{},
)

errors := app.Start()
if len(errors) > 0 {
    // 处理启动错误
}
```

## Start 与 Stop

应用对象内部维护了一个服务提供者列表，在 `Start` 和 `Stop` 时会按约定顺序调用它们：

- `Start`：并发启动所有服务提供者，提高启动速度
- `Stop`：倒序关闭各个服务，确保依赖关系正确

这意味着：

- 先注册的服务会先启动，最后关闭
- 你可以在服务的 `Start` 和 `Stop` 中进行资源初始化和释放

## 请求生命周期

当 HTTP 服务启动后，每一个进入应用的请求大致会经历以下步骤：

1. HTTP 服务器接收请求
2. 请求进入中间件管道，执行全局与路由中间件
3. 路由解析 URL，找到对应的控制器或处理函数
4. 服务容器解析控制器依赖并实例化控制器
5. 调用控制器方法或处理函数，生成响应
6. 响应通过中间件返回并最终发送给客户端

你在 "基础功能" 章节中看到的路由、中间件、控制器等，都是建立在这一路径之上的。

## 在生命周期中扩展应用

根据生命周期的不同阶段，常见的扩展方式包括：

- 在服务提供者的 `Register` 中向容器注册绑定
- 在服务提供者的 `Start` 中启动后台任务或监听器
- 在 HTTP 服务启动后，通过中间件与路由扩展请求处理

建议将所有与生命周期相关的逻辑收敛到服务提供者中，而不是零散地分布在应用各处，这样更便于维护和测试。
