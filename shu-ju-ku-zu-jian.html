<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>数据库组件 - goal-web</title><meta name="description" content="Goal-web/database goal-web/database goal 框架的数据库组件，当然你也可以在 goal 之外的框架使用他。 目前数据库组件暂时不能使用关联关系，你可以用 WhereExists 来代替 go get github.com/goal-web/database 使用 - usage goal 的脚手架自带了绝大多数开发一个 web 应用的所需要的功能和组件，当然包括了数据库组件。一般情况下，我们只需要在 .env 修改自己的数据库配置即可，添加数据库连接可以 config/database.go 修改 Connections 属性。 默认情况下，config/database.go 配置文件像下面那样，默认添加了 sqlite、MySQL、postgresSql 三个数据库连接的配置 和 Laravel 不同的是，goal 把 redis 配置独立出去了，因为 redis 也是一个独立的模块，不想让 redis 依赖 database package config import ( &quot;github.com/goal-web/contracts&quot;&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://goal-web.com/shu-ju-ku-zu-jian.html"><link rel="alternate" type="application/atom+xml" href="https://goal-web.com/feed.xml"><link rel="alternate" type="application/json" href="https://goal-web.com/feed.json"><meta property="og:title" content="数据库组件"><meta property="og:site_name" content="goal-web"><meta property="og:description" content="Goal-web/database goal-web/database goal 框架的数据库组件，当然你也可以在 goal 之外的框架使用他。 目前数据库组件暂时不能使用关联关系，你可以用 WhereExists 来代替 go get github.com/goal-web/database 使用 - usage goal 的脚手架自带了绝大多数开发一个 web 应用的所需要的功能和组件，当然包括了数据库组件。一般情况下，我们只需要在 .env 修改自己的数据库配置即可，添加数据库连接可以 config/database.go 修改 Connections 属性。 默认情况下，config/database.go 配置文件像下面那样，默认添加了 sqlite、MySQL、postgresSql 三个数据库连接的配置 和 Laravel 不同的是，goal 把 redis 配置独立出去了，因为 redis 也是一个独立的模块，不想让 redis 依赖 database package config import ( &quot;github.com/goal-web/contracts&quot;&hellip;"><meta property="og:url" content="https://goal-web.com/shu-ju-ku-zu-jian.html"><meta property="og:type" content="article"><link rel="stylesheet" href="https://goal-web.com/assets/css/style.css?v=7c7ed2e3e90182a09465f36ea7129616"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://goal-web.com/shu-ju-ku-zu-jian.html"},"headline":"数据库组件","datePublished":"2022-04-08T11:28","dateModified":"2023-01-31T22:29","description":"Goal-web/database goal-web/database goal 框架的数据库组件，当然你也可以在 goal 之外的框架使用他。 目前数据库组件暂时不能使用关联关系，你可以用 WhereExists 来代替 go get github.com/goal-web/database 使用 - usage goal 的脚手架自带了绝大多数开发一个 web 应用的所需要的功能和组件，当然包括了数据库组件。一般情况下，我们只需要在 .env 修改自己的数据库配置即可，添加数据库连接可以 config/database.go 修改 Connections 属性。 默认情况下，config/database.go 配置文件像下面那样，默认添加了 sqlite、MySQL、postgresSql 三个数据库连接的配置 和 Laravel 不同的是，goal 把 redis 配置独立出去了，因为 redis 也是一个独立的模块，不想让 redis 依赖 database package config import ( &quot;github.com/goal-web/contracts&quot;&hellip;","author":{"@type":"Person","name":"qbhy","url":"https://goal-web.com/zuo-zhe/qbhy/"},"publisher":{"@type":"Organization","name":"qbhy"}}</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://goal-web.com/">goal-web</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://github.com/goal-web/goal" title="github" target="_blank" rel="_blank">github仓库</a></li><li><a href="https://goal-web.com/goal-kuai-su-kai-shi.html" target="_self">快速开始</a></li><li><a href="https://goal-web.com/goal-features.html" target="_self">组件</a></li><li><a href="https://goal-web.com/join-goal.html" target="_self">加入我们</a></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-04-08T11:28">四月 8, 2022</time></div><h1>数据库组件</h1><div class="post__meta post__meta--author"><a href="https://goal-web.com/zuo-zhe/qbhy/" class="feed__author">qbhy</a></div></div></header></div><div class="wrapper post__entry"><h1 id="goal-webdatabase">Goal-web/database</h1><p><a href="https://github.com/goal-web/database">goal-web/database</a><br>goal 框架的数据库组件，当然你也可以在 goal 之外的框架使用他。</p><blockquote><p>目前数据库组件暂时不能使用关联关系，你可以用 <code>WhereExists</code> 来代替</p></blockquote><h2 id="安装---install">安装 - install</h2><pre><code class="language-bash">go get github.com/goal-web/database
</code></pre><h2 id="使用---usage">使用 - usage</h2><p>goal 的脚手架自带了绝大多数开发一个 web 应用的所需要的功能和组件，当然包括了数据库组件。一般情况下，我们只需要在 .env 修改自己的数据库配置即可，添加数据库连接可以 <code>config/database.go</code> 修改 <code>Connections</code> 属性。</p><h3 id="配置---config">配置 - config</h3><p>默认情况下，<code>config/database.go</code> 配置文件像下面那样，默认添加了 sqlite、MySQL、postgresSql 三个数据库连接的配置</p><blockquote><p>和 <code>Laravel</code> 不同的是，goal 把 redis 配置独立出去了，因为 redis 也是一个独立的模块，不想让 redis 依赖 database</p></blockquote><pre><code class="language-go">package config
import (
    &quot;github.com/goal-web/contracts&quot;
    &quot;github.com/goal-web/database&quot;
)
func init() {
    configs[&quot;database&quot;] = func(env contracts.Env) interface{} {
        return database.Config{
            Default: env.StringOption(&quot;db.connection&quot;, &quot;mysql&quot;),
            Connections: map[string]contracts.Fields{
                &quot;sqlite&quot;: {
                    &quot;driver&quot;:   &quot;sqlite&quot;,
                    &quot;database&quot;: env.GetString(&quot;sqlite.database&quot;),
                },
                &quot;mysql&quot;: {
                    &quot;driver&quot;:          &quot;mysql&quot;,
                    &quot;host&quot;:            env.GetString(&quot;db.host&quot;),
                    &quot;port&quot;:            env.GetString(&quot;db.port&quot;),
                    &quot;database&quot;:        env.GetString(&quot;db.database&quot;),
                    &quot;username&quot;:        env.GetString(&quot;db.username&quot;),
                    &quot;password&quot;:        env.GetString(&quot;db.password&quot;),
                    &quot;unix_socket&quot;:     env.GetString(&quot;db.unix_socket&quot;),
                    &quot;charset&quot;:         env.StringOption(&quot;db.charset&quot;, &quot;utf8mb4&quot;),
                    &quot;collation&quot;:       env.StringOption(&quot;db.collation&quot;, &quot;utf8mb4_unicode_ci&quot;),
                    &quot;prefix&quot;:          env.GetString(&quot;db.prefix&quot;),
                    &quot;strict&quot;:          env.GetBool(&quot;db.struct&quot;),
                    &quot;max_connections&quot;: env.GetInt(&quot;db.max_connections&quot;),
                    &quot;max_idles&quot;:       env.GetInt(&quot;db.max_idles&quot;),
                },
                &quot;pgsql&quot;: {
                    &quot;driver&quot;:          &quot;postgres&quot;,
                    &quot;host&quot;:            env.GetString(&quot;db.pgsql.host&quot;),
                    &quot;port&quot;:            env.GetString(&quot;db.pgsql.port&quot;),
                    &quot;database&quot;:        env.GetString(&quot;db.pgsql.database&quot;),
                    &quot;username&quot;:        env.GetString(&quot;db.pgsql.username&quot;),
                    &quot;password&quot;:        env.GetString(&quot;db.pgsql.password&quot;),
                    &quot;charset&quot;:         env.StringOption(&quot;db.pgsql.charset&quot;, &quot;utf8mb4&quot;),
                    &quot;prefix&quot;:          env.GetString(&quot;db.pgsql.prefix&quot;),
                    &quot;schema&quot;:          env.StringOption(&quot;db.pgsql.schema&quot;, &quot;public&quot;),
                    &quot;sslmode&quot;:         env.StringOption(&quot;db.pgsql.sslmode&quot;, &quot;disable&quot;),
                    &quot;max_connections&quot;: env.GetInt(&quot;db.pgsql.max_connections&quot;),
                    &quot;max_idles&quot;:       env.GetInt(&quot;db.pgsql.max_idles&quot;),
                },
            },
        }
    }
}
</code></pre><p><code>.env</code> 的数据库相关配置</p><pre><code class="language-bash"># 默认连接
db.connection=sqlite

sqlite.database=/Users/qbhy/project/go/goal-web/goal/example/database/db.sqlite

db.host=localhost
db.port=3306
db.database=goal
db.username=root
db.password=password

db.pgsql.host=localhost
db.pgsql.port=55433
db.pgsql.database=postgres
db.pgsql.username=postgres
db.pgsql.password=123456
</code></pre><h3 id="定义模型---define-a-model">定义模型 - define a model</h3><p><code>app/models/user.go</code> 文件</p><pre><code class="language-go">package models

import (
    &quot;github.com/goal-web/database/table&quot;
    &quot;github.com/goal-web/supports/class&quot;
)

// UserClass 这个类变量，以后大有用处
var UserClass = class.Make(new(User))

// UserModel 返回 table 实例，继承自查询构造器并且实现了所有 future
func UserModel() *table.Table {
    return table.Model(UserClass, &quot;users&quot;)
}

// User 模型结构体
type User struct {
    Id       int64  `json:&quot;id&quot;`
    NickName string `json:&quot;name&quot;`
}
</code></pre><h3 id="用法---method-of-use">用法 - method of use</h3><pre><code class="language-go">package tests

import (
    &quot;fmt&quot;
    &quot;github.com/goal-web/contracts&quot;
    &quot;github.com/goal-web/database/table&quot;
    &quot;github.com/goal-web/example/models&quot;
    &quot;github.com/stretchr/testify/assert&quot;
    &quot;testing&quot;
)

func getQuery(name string) contracts.QueryBuilder {
    // 测试用例环境下的简易 goal 应用启动
    app := initApp(&quot;/Users/qbhy/project/go/goal-web/goal/tests&quot;)

    //return  table.Query(&quot;users&quot;) 返回 table 实例，使用默认连接
    //tx, _ := app.Get(&quot;db&quot;).(contracts.DBConnection).Begin()
    //return table.WithTX(&quot;users&quot;, tx) // 事物环境下执行

    //return table.WithConnection(name, &quot;sqlite&quot;) // 返回指定连接的 table 实例，使用连接名
    return table.WithConnection(name, app.Get(&quot;db&quot;).(contracts.DBConnection)) // 也可以指定连接实例
}

// TestTableQuery 测试不带模型的 table 查询，类似 laravel 的 DB::table()
func TestTableQuery(t *testing.T) {

    getQuery(&quot;users&quot;).Delete()

    // 不设置模型的情况下，返回 contracts.Fields
    user := getQuery(&quot;users&quot;).Create(contracts.Fields{
        &quot;name&quot;: &quot;qbhy&quot;,
    }).(contracts.Fields)

    fmt.Println(user)
    userId := user[&quot;id&quot;].(int64)
    // 判断插入是否成功
    assert.True(t, userId &gt; 0)

    // 获取数据总量
    assert.True(t, getQuery(&quot;users&quot;).Count() == 1)

    // 修改数据
    num := getQuery(&quot;users&quot;).Where(&quot;name&quot;, &quot;qbhy&quot;).Update(contracts.Fields{
        &quot;name&quot;: &quot;goal&quot;,
    })
    assert.True(t, num == 1)
    // 判断修改后的数据
    user = getQuery(&quot;users&quot;).Where(&quot;name&quot;, &quot;goal&quot;).First().(contracts.Fields)

    err := getQuery(&quot;users&quot;).Chunk(10, func(collection contracts.Collection, page int) error {
        assert.True(t, collection.Len() == 1)
        fmt.Println(collection.ToJson())
        return nil
    })

    assert.Nil(t, err)

    assert.True(t, user[&quot;id&quot;] == userId)
    assert.True(t, user[&quot;name&quot;] == &quot;goal&quot;)
    assert.True(t, getQuery(&quot;users&quot;).Find(userId).(contracts.Fields)[&quot;id&quot;] == userId)
    assert.True(t, getQuery(&quot;users&quot;).Where(&quot;id&quot;, userId).Delete() == 1)
    assert.Nil(t, getQuery(&quot;users&quot;).Find(userId))
}

func TestModel(t *testing.T) {
    initApp(&quot;/Users/qbhy/project/go/goal-web/goal/tests&quot;)

    fmt.Println(&quot;用table查询：&quot;,
        getQuery(&quot;users&quot;).Get().Map(func(user contracts.Fields) {
            fmt.Println(&quot;用table查询&quot;, user)
        }).ToJson()) // query 返回 Collection&lt;contracts.Fields&gt;

    user := models.UserModel().Create(contracts.Fields{
        &quot;name&quot;: &quot;qbhy&quot;,
    }).(models.User)

    fmt.Println(&quot;创建后返回模型&quot;, user)

    fmt.Println(&quot;用table查询：&quot;,
        getQuery(&quot;users&quot;).Get().Map(func(user contracts.Fields) {
            fmt.Println(&quot;用table查询&quot;, user)
        }).ToJson()) // query 返回 Collection&lt;contracts.Fields&gt;

        // 用模型查询
    fmt.Println(models.UserModel(). // model 返回 Collection&lt;models.User&gt;
                    Get().
                    Map(func(user models.User) {
            fmt.Println(&quot;id:&quot;, user.Id)
        }).ToJson())

    fmt.Println(models.UserModel().Where(&quot;id&quot;, &quot;&gt;&quot;, 0).Delete())
}
</code></pre><blockquote><p>更多查询构造器用法请移步 <a href="https://github.com/goal-web/querybuilder">goal-web/querybuilder</a></p></blockquote><h3 id="在-goal-之外的框架使用---use-in-frameworks-other-than-goal">在 goal 之外的框架使用 - use in frameworks other than goal</h3><pre><code class="language-golang">// TestMysqlDatabaseWithoutApplication 只需要给给 table 包设置一个可用的 contracts.DBFactory 即可正常使用 table 下面的数据库操作方法
func TestMysqlDatabaseWithoutApplication(t *testing.T) {
    table.SetFactory(database.NewFactory(database.Config{
        Default: &quot;mysql&quot;,
        Connections: map[string]contracts.Fields{
            &quot;mysql&quot;: {
                &quot;driver&quot;:    &quot;mysql&quot;,
                &quot;host&quot;:      &quot;localhost&quot;,
                &quot;port&quot;:      &quot;3306&quot;,
                &quot;database&quot;:  &quot;goal&quot;,
                &quot;username&quot;:  &quot;root&quot;,
                &quot;password&quot;:  &quot;123456&quot;,
                &quot;charset&quot;:   &quot;utf8mb4&quot;,
                &quot;collation&quot;: &quot;utf8mb4_unicode_ci&quot;,
            },
        },
    }, nil))

    assert.True(t, table.Query(&quot;users&quot;).Count() == 0)

    user := table.Query(&quot;users&quot;).Create(contracts.Fields{
        &quot;name&quot;: &quot;testing&quot;,
    })
    assert.NotNil(t, user)
    assert.True(t, user.(contracts.Fields)[&quot;name&quot;] == &quot;testing&quot;)
    assert.True(t, table.Query(&quot;users&quot;).Count() == 1)
    table.Query(&quot;users&quot;).Where(&quot;name&quot;, &quot;testing&quot;).Delete()
    assert.True(t, table.Query(&quot;users&quot;).Count() == 0)
}
</code></pre><p><a href="https://github.com/goal-web/goal">goal-web</a><br><a href="https://github.com/goal-web/database">goal-web/database</a><br><a href="mailto:&#x71;&#98;&#104;&#121;&#x30;&#55;&#49;&#53;&#64;&#113;&#x71;&#x2e;&#x63;&#x6f;&#109;">&#x71;&#98;&#104;&#121;&#x30;&#55;&#49;&#53;&#64;&#113;&#x71;&#x2e;&#x63;&#x6f;&#109;</a></p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on 一月 31, 2023</p><ul class="post__tag"><li><a href="https://goal-web.com/biao-qian/goalzu-jian/">goal组件</a></li><li><a href="https://goal-web.com/biao-qian/golangshu-ju-ku-gong-ju/">golang数据库工具</a></li></ul><div class="post__share"></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://goal-web.com/zuo-zhe/qbhy/" rel="author">qbhy</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://goal-web.com/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://goal-web.com/querybuilder-cha-xun-gou-zao-qi-zu-jian.html" class="post__nav-link" rel="prev"><span>Previous</span> QueryBuilder - 查询构造器组件</a></div></div></nav></main><footer class="footer"><div class="footer__social"></div><div class="footer__copyright"><p>Powered by Publii</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://goal-web.com/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://goal-web.com/assets/js/scripts.min.js?v=6ca8b60e6534a3888de1205e82df8528"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>