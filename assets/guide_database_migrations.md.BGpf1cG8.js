import{_ as i,c as a,o as n,ae as t}from"./chunks/framework.DYx9Zc8T.js";const g=JSON.parse('{"title":"数据库迁移","description":"","frontmatter":{},"headers":[],"relativePath":"guide/database/migrations.md","filePath":"guide/database/migrations.md"}'),l={name:"guide/database/migrations.md"};function e(h,s,p,k,d,r){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="数据库迁移" tabindex="-1">数据库迁移 <a class="header-anchor" href="#数据库迁移" aria-label="Permalink to &quot;数据库迁移&quot;">​</a></h1><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>数据库迁移用于对结构变更进行版本化管理，让你可以：</p><ul><li>在团队内同步表结构变更</li><li>在不同环境（开发 / 测试 / 生产）之间安全迁移</li><li>快速回滚到某个历史结构</li></ul><p>Goal-Web 的迁移基于 SQL 文件和一组控制台命令实现。</p><h2 id="迁移文件位置与命名" tabindex="-1">迁移文件位置与命名 <a class="header-anchor" href="#迁移文件位置与命名" aria-label="Permalink to &quot;迁移文件位置与命名&quot;">​</a></h2><p>迁移文件默认存放在 <code>database/migrations</code> 目录中，对应的配置在 <code>config/database.go</code> 中：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Migrations: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">contracts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Fields</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;table&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;migrations&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;database/migrations&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span></code></pre></div><p>迁移由一对文件组成：</p><ul><li><code>YYYY_MM_DD_HHMMSS_name.sql</code> ：执行迁移时运行的 SQL（up）</li><li><code>YYYY_MM_DD_HHMMSS_name.down.sql</code> ：回滚迁移时运行的 SQL（down）</li></ul><p>你可以使用命令自动生成基础迁移文件。</p><h2 id="生成迁移" tabindex="-1">生成迁移 <a class="header-anchor" href="#生成迁移" aria-label="Permalink to &quot;生成迁移&quot;">​</a></h2><p>在应用根目录执行：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> make:migration</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_users</span></span></code></pre></div><p>或使用 <code>goal</code> 下的 Makefile：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> goal</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> make-migration</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NAME=create_users</span></span></code></pre></div><p>该命令会在 <code>database/migrations</code> 目录下生成类似以下两个文件：</p><ul><li><code>2026_01_16_123000_create_users.sql</code></li><li><code>2026_01_16_123000_create_users.down.sql</code></li></ul><p>如果名称以 <code>create_</code> 开头，生成器会自动为 up 文件填充一个简单的建表 SQL，为 down 文件填充 <code>drop table</code> 语句，你可以在此基础上修改字段定义。</p><h2 id="编写迁移-sql" tabindex="-1">编写迁移 SQL <a class="header-anchor" href="#编写迁移-sql" aria-label="Permalink to &quot;编写迁移 SQL&quot;">​</a></h2><p>示例：<code>create_users.sql</code>：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id         </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UNSIGNED AUTO_INCREMENT,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    email      </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    password</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    updated_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">InnoDB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">utf8mb4;</span></span></code></pre></div><p>对应的 <code>create_users.down.sql</code>：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users;</span></span></code></pre></div><h2 id="运行迁移" tabindex="-1">运行迁移 <a class="header-anchor" href="#运行迁移" aria-label="Permalink to &quot;运行迁移&quot;">​</a></h2><p>常用的迁移命令（在应用根目录）：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # 执行所有未运行的迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate:rollback</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 回滚上一次批次的迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate:refresh</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 回滚所有迁移并重新执行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate:reset</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 回滚所有迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootstrap/console/main.go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate:status</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 查看迁移执行状态</span></span></code></pre></div><p>如果你使用 <code>goal</code> 项目的 Makefile，也可以：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> goal</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate-rollback</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate-refresh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate-reset</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate-status</span></span></code></pre></div><p>所有已执行迁移的记录会保存到配置中指定的 <code>migrations</code> 表中，用于决定哪些迁移需要执行或回滚。</p><h2 id="多环境迁移建议" tabindex="-1">多环境迁移建议 <a class="header-anchor" href="#多环境迁移建议" aria-label="Permalink to &quot;多环境迁移建议&quot;">​</a></h2><ul><li><strong>开发环境</strong>：常用 <code>migrate:refresh</code> 快速重建结构</li><li><strong>测试环境</strong>：在 CI 中执行 <code>migrate</code>，确保测试运行前结构正确</li><li><strong>生产环境</strong>：仅在发布管线中运行 <code>migrate</code>，谨慎使用 <code>rollback</code> 和 <code>refresh</code></li></ul><h2 id="下一步" tabindex="-1">下一步 <a class="header-anchor" href="#下一步" aria-label="Permalink to &quot;下一步&quot;">​</a></h2><p>当迁移体系就绪后，你可以结合：</p><ul><li><a href="./query">查询构建器</a> 操作数据</li><li><a href="./orm">模型和 ORM</a> 用模型封装业务</li><li><a href="./seeding">种子数据</a> 为开发和测试填充数据</li></ul>`,35)])])}const E=i(l,[["render",e]]);export{g as __pageData,E as default};
